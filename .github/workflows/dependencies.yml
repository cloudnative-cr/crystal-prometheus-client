name: Check Dependencies

on:
  schedule:
    # Run every Monday at 9:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-shards:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Crystal
        uses: crystal-lang/install-crystal@v1

      - name: Cache shards
        uses: actions/cache@v4
        with:
          path: lib
          key: shards-${{ hashFiles('shard.lock') }}

      - name: Install dependencies
        run: shards install

      - name: Check for outdated shards
        id: outdated
        run: |
          echo "Checking for outdated shards..."
          OUTPUT=$(shards outdated 2>&1 || true)
          echo "$OUTPUT"

          # Check if there are any outdated dependencies
          if echo "$OUTPUT" | grep -q "I: Dependencies are up to date"; then
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "All dependencies are up to date!"
          else
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "Found outdated dependencies"
          fi

          # Save output for issue
          echo "OUTDATED_OUTPUT<<EOF" >> $GITHUB_ENV
          echo "$OUTPUT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Create issue for outdated dependencies
        if: steps.outdated.outputs.has_updates == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const outdatedOutput = process.env.OUTDATED_OUTPUT;
            const title = 'ðŸ“¦ Outdated dependencies detected';
            const body = `## Outdated Dependencies

            The weekly dependency check has found outdated shards:

            \`\`\`
            ${outdatedOutput}
            \`\`\`

            ### To update:

            1. Review the changes in the outdated dependencies
            2. Update version constraints in \`shard.yml\` if needed
            3. Run \`shards update\` locally
            4. Test the changes
            5. Commit the updated \`shard.lock\`

            ---
            *This issue was automatically created by the [dependencies workflow](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/workflows/dependencies.yml)*`;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'dependencies'
            });

            const existingIssue = issues.data.find(issue => issue.title === title);

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## Updated dependency check (${new Date().toISOString().split('T')[0]})

            \`\`\`
            ${outdatedOutput}
            \`\`\`
            `
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['dependencies']
              });
              console.log(`Created new issue #${issue.data.number}`);
            }
